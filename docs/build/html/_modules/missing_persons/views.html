<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>missing_persons.views &#8212; Reunite 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for missing_persons.views</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span><span class="p">,</span> <span class="n">F</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">asin</span><span class="p">,</span> <span class="n">sqrt</span>

<span class="c1"># Create your views here.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">viewsets</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django_filters.rest_framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">DjangoFilterBackend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingPerson</span><span class="p">,</span> <span class="n">MissingPersonDocument</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.serializers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingPersonSerializer</span><span class="p">,</span> <span class="n">MissingPersonDocumentSerializer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blockchain.services</span><span class="w"> </span><span class="kn">import</span> <span class="n">BlockchainService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blockchain.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Block</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.services</span><span class="w"> </span><span class="kn">import</span> <span class="n">BiometricService</span><span class="p">,</span> <span class="n">MissingPersonService</span><span class="p">,</span><span class="n">PosterService</span><span class="p">,</span><span class="n">AnalyticsService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.parsers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiPartParser</span><span class="p">,</span> <span class="n">FormParser</span><span class="p">,</span> <span class="n">JSONParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.files.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentFile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">deepface</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepFace</span>
<span class="c1"># from django.contrib.gis.geos import Point</span>
<span class="c1"># from django.contrib.gis.db.models.functions import Distance</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">accounts.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">FamilyMember</span><span class="p">,</span> <span class="n">FamilyGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">accounts.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="c1"># from rest_framework.parsers import MultiPartParser, FormParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.files.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_storage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.files.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentFile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fitz</span>  <span class="c1"># PyMuPDF</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cloudinary.uploader</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote</span>

<div class="viewcode-block" id="MissingPersonViewSet">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MissingPersonViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MissingPersonSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">DjangoFilterBackend</span><span class="p">,</span> <span class="n">filters</span><span class="o">.</span><span class="n">SearchFilter</span><span class="p">]</span>
    <span class="n">filterset_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">]</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;case_number&#39;</span><span class="p">,</span> <span class="s1">&#39;aadhaar_number&#39;</span><span class="p">]</span>
    <span class="n">parser_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">MultiPartParser</span><span class="p">,</span> <span class="n">FormParser</span><span class="p">,</span> <span class="n">JSONParser</span><span class="p">)</span>

<div class="viewcode-block" id="MissingPersonViewSet.get_queryset">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">:</span>
            <span class="c1"># Show missing persons reported by user or their family members</span>
            <span class="n">family_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">reporter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">family_group__in</span><span class="o">=</span><span class="n">family_groups</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.get_serializer_class">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.get_serializer_class">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;retrieve&#39;</span><span class="p">,</span> <span class="s1">&#39;detail_search&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">MissingPersonSerializer</span>
        <span class="k">return</span> <span class="n">MissingPersonSerializer</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.create">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.create">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Files in request:&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>  <span class="c1"># Debug print</span>
            
            <span class="c1"># Create a new dict for data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># Separate files and data</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;documents[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># Generate case number</span>
            <span class="n">case_number</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MP</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="s1">&#39;0123456789ABCDEF&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;case_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">case_number</span>
            
            <span class="c1"># data[&#39;reporter&#39;] = request.user.id</span>
            
            <span class="c1"># Handle JSON fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;physical_attributes&#39;</span><span class="p">,</span> <span class="s1">&#39;possible_locations&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
                    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c1"># Create missing person first</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">missing_person</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">reporter</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">case_number</span><span class="o">=</span><span class="n">case_number</span>
            <span class="p">)</span>

            <span class="c1"># Handle documents</span>
            <span class="n">document_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;documents[&#39;</span><span class="p">):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">document_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Document indices found:&quot;</span><span class="p">,</span> <span class="n">document_indices</span><span class="p">)</span>  <span class="c1"># Debug print</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">document_indices</span><span class="p">:</span>
                <span class="n">doc_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;documents[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">][document_type]&#39;</span><span class="p">)</span>
                <span class="n">doc_desc</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;documents[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">][description]&#39;</span><span class="p">)</span>
                <span class="c1"># Check both possible file keys</span>
                <span class="n">doc_file</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;documents[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">][file]&#39;</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;documents[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">][document]&#39;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing document </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>  <span class="c1"># Debug print</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type: </span><span class="si">{</span><span class="n">doc_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">doc_desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">doc_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">doc_type</span> <span class="ow">and</span> <span class="n">doc_desc</span> <span class="ow">and</span> <span class="n">doc_file</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">document</span> <span class="o">=</span> <span class="n">MissingPersonDocument</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                            <span class="n">missing_person</span><span class="o">=</span><span class="n">missing_person</span><span class="p">,</span>
                            <span class="n">document_type</span><span class="o">=</span><span class="n">doc_type</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="n">doc_desc</span><span class="p">,</span>
                            <span class="n">file</span><span class="o">=</span><span class="n">doc_file</span><span class="p">,</span>
                            <span class="n">uploaded_by</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Document created: </span><span class="si">{</span><span class="n">document</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Debug print</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating document: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Debug print</span>

            <span class="c1"># Handle recent photo</span>
            <span class="k">if</span> <span class="s1">&#39;recent_photo&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
                <span class="n">missing_person</span><span class="o">.</span><span class="n">recent_photo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;recent_photo&#39;</span><span class="p">]</span>
                <span class="n">missing_person</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># Handle additional photos if any</span>
            <span class="k">if</span> <span class="s1">&#39;additional_photos&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
                <span class="c1"># You might want to handle additional photos here</span>

            <span class="c1"># Refresh instance to get updated data</span>
                <span class="n">missing_person</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">missing_person</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>

            
<div class="viewcode-block" id="MissingPersonViewSet.generate_poster">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.generate_poster">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_poster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">missing_person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">poster_service</span> <span class="o">=</span> <span class="n">PosterService</span><span class="p">()</span>
        <span class="n">poster_file</span> <span class="o">=</span> <span class="n">poster_service</span><span class="o">.</span><span class="n">generate_poster</span><span class="p">(</span><span class="n">missing_person</span><span class="p">)</span>
        
        <span class="n">missing_person</span><span class="o">.</span><span class="n">poster_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">missing_person</span><span class="o">.</span><span class="n">case_number</span><span class="si">}</span><span class="s1">_poster.png&#39;</span><span class="p">,</span> <span class="n">poster_file</span><span class="p">)</span>
        <span class="n">missing_person</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">missing_person</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.share_poster">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.share_poster">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">share_poster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">missing_person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_person</span><span class="o">.</span><span class="n">poster_image</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Poster not generated yet&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="n">poster_url</span> <span class="o">=</span> <span class="n">missing_person</span><span class="o">.</span><span class="n">poster_image</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;instagram&#39;</span><span class="p">:</span>
            <span class="c1"># Simplified Instagram posting (assuming credentials are configured)</span>
            <span class="n">upload_result</span> <span class="o">=</span> <span class="n">cloudinary</span><span class="o">.</span><span class="n">uploader</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">missing_person</span><span class="o">.</span><span class="n">poster_image</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">upload_result</span><span class="p">[</span><span class="s1">&#39;secure_url&#39;</span><span class="p">],</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Posted to Instagram&#39;</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;whatsapp&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">poster_url</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Poster URL ready for WhatsApp&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unsupported platform&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>

    
    
<div class="viewcode-block" id="MissingPersonViewSet.analytics">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.analytics">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analytics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">analytics_service</span> <span class="o">=</span> <span class="n">AnalyticsService</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_cases&#39;</span><span class="p">:</span> <span class="n">analytics_service</span><span class="o">.</span><span class="n">get_total_cases</span><span class="p">(),</span>
            <span class="s1">&#39;cases_by_region&#39;</span><span class="p">:</span> <span class="n">analytics_service</span><span class="o">.</span><span class="n">get_cases_by_region</span><span class="p">(),</span>
            <span class="s1">&#39;resolution_rate&#39;</span><span class="p">:</span> <span class="n">analytics_service</span><span class="o">.</span><span class="n">get_resolution_rate</span><span class="p">(),</span>
            <span class="s1">&#39;heatmap_data&#39;</span><span class="p">:</span> <span class="n">analytics_service</span><span class="o">.</span><span class="n">get_heatmap_data</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.assign_collaborator">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.assign_collaborator">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_collaborator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">missing_person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">collaborator_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;collaborator_id&#39;</span><span class="p">)</span>
        <span class="n">collaborator_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>  <span class="c1"># &#39;officer&#39; or &#39;ngo&#39;</span>
        
        <span class="n">collaborator</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">collaborator_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">collaborator_type</span> <span class="o">==</span> <span class="s1">&#39;officer&#39;</span><span class="p">:</span>
            <span class="n">missing_person</span><span class="o">.</span><span class="n">assigned_officer</span> <span class="o">=</span> <span class="n">collaborator</span>
        <span class="k">elif</span> <span class="n">collaborator_type</span> <span class="o">==</span> <span class="s1">&#39;ngo&#39;</span><span class="p">:</span>
            <span class="n">missing_person</span><span class="o">.</span><span class="n">assigned_ngo</span> <span class="o">=</span> <span class="n">collaborator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid collaborator type&#39;</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
        <span class="n">missing_person</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">missing_person</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.search">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.search">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search missing persons by various parameters&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">)</span>

        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">name__icontains</span><span class="o">=</span><span class="n">query</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">case_number__icontains</span><span class="o">=</span><span class="n">query</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">aadhaar_number__icontains</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">area</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">last_seen_location__icontains</span><span class="o">=</span><span class="n">area</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.haversine_distance">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.haversine_distance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">haversine_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the great circle distance between two points </span>
<span class="sd">        on the earth (specified in decimal degrees)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert decimal degrees to radians</span>
            <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="p">[</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">])</span>
            <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">radians</span><span class="p">,</span> <span class="p">[</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">])</span>

            <span class="c1"># Haversine formula</span>
            <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
            <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">asin</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mi">6371</span>  <span class="c1"># Radius of earth in kilometers</span>
            <span class="k">return</span> <span class="n">c</span> <span class="o">*</span> <span class="n">r</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating distance: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.nearby">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.nearby">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nearby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find missing persons within a radius&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">))</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">))</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))</span>  <span class="c1"># km</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid latitude, longitude, or radius&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="c1"># Get all missing persons with location data</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">last_known_latitude__isnull</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">last_known_longitude__isnull</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Calculate distances and filter</span>
        <span class="n">nearby_persons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">haversine_distance</span><span class="p">(</span>
                    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">last_known_latitude</span><span class="p">),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">last_known_longitude</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">:</span>
                    <span class="n">person</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>  <span class="c1"># Store distance as float</span>
                    <span class="n">nearby_persons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing person </span><span class="si">{</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># Sort by distance</span>
        <span class="n">nearby_persons</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>
        
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">nearby_persons</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.face_search">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.face_search">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">],</span> <span class="n">url_path</span><span class="o">=</span><span class="s1">&#39;face-search&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">face_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for missing persons using facial recognition&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;photo&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Photo is required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">search_photo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;photo&#39;</span><span class="p">]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Save the uploaded photo temporarily</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">search_photo</span><span class="o">.</span><span class="n">chunks</span><span class="p">():</span>
                <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get all missing persons with photos</span>
            <span class="n">persons</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">recent_photo</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">persons</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">DeepFace</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
                        <span class="n">temp_path</span><span class="p">,</span>
                        <span class="n">person</span><span class="o">.</span><span class="n">recent_photo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;VGG-Face&#39;</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;verified&#39;</span><span class="p">]:</span>
                        <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;person_id&#39;</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;case_number&#39;</span><span class="p">:</span> <span class="n">person</span><span class="o">.</span><span class="n">case_number</span><span class="p">,</span>
                            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>
                        <span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clean up the temporary file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="n">matches</span><span class="p">})</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.update_status">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.update_status">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PATCH&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the status of a missing person case&quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">MissingPerson</span><span class="o">.</span><span class="n">STATUS_CHOICES</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid status&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.update_location">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.update_location">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the last known location of a missing person&quot;&quot;&quot;</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Latitude and longitude are required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">last_known_latitude</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">last_known_longitude</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.match_biometrics">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.match_biometrics">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">match_biometrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match uploaded biometric data against database&quot;&quot;&quot;</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;photo&#39;</span><span class="p">)</span>
        <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fingerprint&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">photo</span> <span class="ow">or</span> <span class="n">fingerprint</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No biometric data provided&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
        
        <span class="n">biometric_service</span> <span class="o">=</span> <span class="n">BiometricService</span><span class="p">()</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">photo</span><span class="p">:</span>
            <span class="n">person_id</span><span class="p">,</span> <span class="n">confidence</span> <span class="o">=</span> <span class="n">biometric_service</span><span class="o">.</span><span class="n">match_face</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">temporary_file_path</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>  <span class="c1"># Threshold for matching</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;facial&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;person_id&#39;</span><span class="p">:</span> <span class="n">person_id</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">confidence</span>
                <span class="p">})</span>
        
        <span class="k">if</span> <span class="n">fingerprint</span><span class="p">:</span>
            <span class="n">person_id</span><span class="p">,</span> <span class="n">confidence</span> <span class="o">=</span> <span class="n">biometric_service</span><span class="o">.</span><span class="n">match_fingerprint</span><span class="p">(</span>
                <span class="n">fingerprint</span><span class="o">.</span><span class="n">temporary_file_path</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;fingerprint&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;person_id&#39;</span><span class="p">:</span> <span class="n">person_id</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">confidence</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="n">matches</span><span class="p">})</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.report_self">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.report_self">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">report_self</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Report self as missing&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create missing person record for self</span>
            <span class="n">missing_person</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">(),</span>
                <span class="n">registered_user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">is_registered_user</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">reporter</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">reporter_type</span><span class="o">=</span><span class="s1">&#39;SELF&#39;</span><span class="p">,</span>
                <span class="c1"># Pre-fill other fields from user profile</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">get_user_details</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">MissingPersonSerializer</span><span class="p">(</span><span class="n">missing_person</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.report_family_member">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.report_family_member">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">report_family_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Report a family member as missing&quot;&quot;&quot;</span>
        <span class="n">family_member_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;family_member_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">family_member_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Family member ID is required&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>
            
        <span class="n">details</span> <span class="o">=</span> <span class="n">MissingPersonService</span><span class="o">.</span><span class="n">get_family_member_details</span><span class="p">(</span><span class="n">family_member_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Family member not found&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>
            
        <span class="c1"># Create missing person record with pre-filled details</span>
        <span class="n">missing_person</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">reporter</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">reporter_type</span><span class="o">=</span><span class="s1">&#39;FAMILY&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">details</span><span class="p">,</span>
            <span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">data</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">MissingPersonSerializer</span><span class="p">(</span><span class="n">missing_person</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.detail_search">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.detail_search">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">url_path</span><span class="o">=</span><span class="s1">&#39;detail-search&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">detail_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for a missing person with detailed information including family data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get query parameters</span>
        <span class="n">case_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;case_number&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">aadhaar</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aadhaar&#39;</span><span class="p">)</span>
        <span class="n">phone</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phone&#39;</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>

        <span class="c1"># Start with all persons</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Build query based on provided parameters</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">case_number</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">|=</span> <span class="n">Q</span><span class="p">(</span><span class="n">case_number__iexact</span><span class="o">=</span><span class="n">case_number</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">|=</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">name__icontains</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="o">|</span> 
                       <span class="n">Q</span><span class="p">(</span><span class="n">family_group__members__name__icontains</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">aadhaar</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">|=</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">aadhaar_number__iexact</span><span class="o">=</span><span class="n">aadhaar</span><span class="p">)</span> <span class="o">|</span> 
                       <span class="n">Q</span><span class="p">(</span><span class="n">family_group__members__aadhaar_number__iexact</span><span class="o">=</span><span class="n">aadhaar</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">|=</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">emergency_contact_phone__icontains</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span> <span class="o">|</span>
                       <span class="n">Q</span><span class="p">(</span><span class="n">secondary_contact_phone__icontains</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span> <span class="o">|</span>
                       <span class="n">Q</span><span class="p">(</span><span class="n">family_group__members__contact_number__icontains</span><span class="o">=</span><span class="n">phone</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">location</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">|=</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">last_seen_location__icontains</span><span class="o">=</span><span class="n">location</span><span class="p">)</span> <span class="o">|</span>
                       <span class="n">Q</span><span class="p">(</span><span class="n">possible_locations__icontains</span><span class="o">=</span><span class="n">location</span><span class="p">))</span>

        <span class="c1"># If no search parameters provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">case_number</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">aadhaar</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">location</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Please provide at least one search parameter&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="c1"># Apply filters</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

        <span class="c1"># Optimize query</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;family_group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span>
            <span class="s1">&#39;documents&#39;</span><span class="p">,</span>
            <span class="s1">&#39;family_group__members&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Get results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queryset</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No matching records found&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="c1"># Serialize the results</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.retrieve">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.retrieve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.search_by_aadhaar">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.search_by_aadhaar">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">],</span> <span class="n">url_path</span><span class="o">=</span><span class="s1">&#39;aadhaar-search&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">search_by_aadhaar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for missing persons by Aadhaar number or Aadhaar card photo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aadhaar_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aadhaar_number&#39;</span><span class="p">)</span>
        <span class="n">aadhaar_photo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aadhaar_photo&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">aadhaar_number</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">aadhaar_photo</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Please provide either Aadhaar number or Aadhaar card photo&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Search by Aadhaar number</span>
        <span class="k">if</span> <span class="n">aadhaar_number</span><span class="p">:</span>
            <span class="n">persons</span> <span class="o">=</span> <span class="n">MissingPerson</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">aadhaar_number</span><span class="o">=</span><span class="n">aadhaar_number</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">persons</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">persons</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Search by Aadhaar photo</span>
        <span class="k">if</span> <span class="n">aadhaar_photo</span><span class="p">:</span>
            <span class="c1"># Save uploaded photo temporarily</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">aadhaar_photo</span><span class="o">.</span><span class="n">chunks</span><span class="p">():</span>
                    <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">temp_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get all Aadhaar card documents</span>
                <span class="n">aadhaar_docs</span> <span class="o">=</span> <span class="n">MissingPersonDocument</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">document_type</span><span class="o">=</span><span class="s1">&#39;ID_PROOF&#39;</span><span class="p">,</span>
                    <span class="n">description__icontains</span><span class="o">=</span><span class="s1">&#39;Aadhaar&#39;</span>
                <span class="p">)</span>

                <span class="c1"># Compare with each Aadhaar document</span>
                <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">aadhaar_docs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">DeepFace</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
                            <span class="n">temp_path</span><span class="p">,</span>
                            <span class="n">doc</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                            <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;VGG-Face&#39;</span><span class="p">,</span>
                            <span class="n">distance_metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verified&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">missing_person</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">missing_person</span>
                            <span class="n">match_data</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;person&#39;</span><span class="p">:</span> <span class="n">missing_person</span><span class="p">,</span>
                                <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="p">}</span>
                            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match_data</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing document </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Clean up temporary file</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

            <span class="c1"># Sort matches by confidence</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Return results</span>
            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">persons</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
                <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">persons</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                    <span class="s1">&#39;matches&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="s1">&#39;match_confidences&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No matching records found&#39;</span><span class="p">},</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.convert_pdf_and_post">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.convert_pdf_and_post">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">],</span> <span class="n">url_path</span><span class="o">=</span><span class="s1">&#39;convert-and-post&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_pdf_and_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert PDF to PNG, save both files, upload to Cloudinary, and post to Instagram</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;pdf_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Please provide a PDF file&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="c1"># Instagram API configuration</span>
        <span class="n">INSTAGRAM_ACCOUNT_ID</span> <span class="o">=</span> <span class="s2">&quot;17841468077947131&quot;</span>
        <span class="n">ACCESS_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;EAAX4kmSL4uMBO77bTujUCmsLN4WsZBGwpkehN51bqbYUXb2RDZBBc2iU9hnxy5ptr8Y7QqWpLYXWatRqR4N29Wd321FC0hwV3edugzJb0uvOFmjUtxAbm5bOi9GgHtE8FaHR1mXMiqnrkh9bEhYNwShSlTLNhF9npqb429hdtegc2m1CBb9fJo&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># pdf_file = request.FILES[&#39;pdf_file&#39;]</span>
            <span class="c1"># case_number = request.data.get(&#39;case_number&#39;)</span>
            <span class="c1"># person_name = request.data.get(&#39;person_name&#39;, &#39;&#39;)</span>

            <span class="c1"># # Save PDF file</span>
            <span class="c1"># pdf_path = f&#39;posters/{case_number}_poster.pdf&#39;</span>
            <span class="c1"># with default_storage.open(pdf_path, &#39;wb+&#39;) as destination:</span>
            <span class="c1">#     for chunk in pdf_file.chunks():</span>
            <span class="c1">#         destination.write(chunk)</span>
            <span class="c1"># Step 1: Convert PDF and upload to Cloudinary</span>
            <span class="n">cloudinary_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_cloudinary</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;pdf_file&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cloudinary_url</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to convert and upload PDF&#39;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="c1"># Step 2: Create Instagram media container</span>
            <span class="n">creation_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_instagram_container</span><span class="p">(</span>
                <span class="n">cloudinary_url</span><span class="p">,</span>
                <span class="n">INSTAGRAM_ACCOUNT_ID</span><span class="p">,</span>
                <span class="n">ACCESS_TOKEN</span><span class="p">,</span>
                <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;person_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># Get person&#39;s name from request</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">creation_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to create Instagram media container&#39;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="c1"># Step 3: Publish to Instagram</span>
            <span class="n">published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish_to_instagram</span><span class="p">(</span>
                <span class="n">creation_id</span><span class="p">,</span>
                <span class="n">INSTAGRAM_ACCOUNT_ID</span><span class="p">,</span>
                <span class="n">ACCESS_TOKEN</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">published</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to publish to Instagram&#39;</span><span class="p">},</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Successfully converted and posted to Instagram&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cloudinary_url&#39;</span><span class="p">:</span> <span class="n">cloudinary_url</span><span class="p">,</span>
                <span class="s1">&#39;instagram_post_id&#39;</span><span class="p">:</span> <span class="n">published</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Process failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.convert_to_cloudinary">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.convert_to_cloudinary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_to_cloudinary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdf_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert PDF to PNG and upload to Cloudinary&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
                <span class="c1"># Save PDF temporarily</span>
                <span class="n">temp_pdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;temp.pdf&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_pdf_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">pdf_file</span><span class="o">.</span><span class="n">chunks</span><span class="p">():</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

                <span class="c1"># Convert first page to PNG</span>
                <span class="n">pdf_document</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_pdf_path</span><span class="p">)</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">pdf_document</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pix</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">fitz</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                
                <span class="c1"># Save PNG temporarily</span>
                <span class="n">temp_png_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;temp.png&#39;</span><span class="p">)</span>
                <span class="n">pix</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">temp_png_path</span><span class="p">)</span>
                
                <span class="c1"># Upload to Cloudinary</span>
                <span class="n">upload_result</span> <span class="o">=</span> <span class="n">cloudinary</span><span class="o">.</span><span class="n">uploader</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
                    <span class="n">temp_png_path</span><span class="p">,</span>
                    <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;pdf_conversions&#39;</span><span class="p">,</span>
                    <span class="n">public_id</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;pdf_convert_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s1">_1&#39;</span>
                <span class="p">)</span>
                
                <span class="n">pdf_document</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">upload_result</span><span class="p">[</span><span class="s1">&#39;secure_url&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.create_instagram_container">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.create_instagram_container">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_instagram_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_url</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">person_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Instagram media container&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Please help us find the above person. If you have any information, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;please contact on the given info or local authorities immediately.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📢 Share &amp; spread the word! Every share helps bring them home. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🙏💙 #MissingPerson #HelpFind</span><span class="si">{</span><span class="n">person_name</span><span class="si">}</span><span class="s2"> #SpreadTheWord&quot;</span>
            <span class="p">)</span>

            <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;https://graph.facebook.com/v20.0/</span><span class="si">{</span><span class="n">account_id</span><span class="si">}</span><span class="s2">/media&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;?image_url=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&amp;caption=</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&amp;access_token=</span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&amp;media_type=IMAGE&quot;</span>
            <span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Container creation error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.publish_to_instagram">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.publish_to_instagram">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">publish_to_instagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creation_id</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">access_token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Publish to Instagram&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;https://graph.facebook.com/v20.0/</span><span class="si">{</span><span class="n">account_id</span><span class="si">}</span><span class="s2">/media_publish&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;?creation_id=</span><span class="si">{</span><span class="n">creation_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&amp;access_token=</span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Publishing error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MissingPersonViewSet.list_all">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonViewSet.list_all">[docs]</a>
    <span class="nd">@action</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of all missing persons with optional filters&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get filter parameters from query string</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">),</span>
                <span class="s1">&#39;gender&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">),</span>
                <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">),</span>
            <span class="p">}</span>
            
            <span class="c1"># Remove None values</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
            
            <span class="c1"># Get search query</span>
            <span class="n">search_query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">)</span>
            
            <span class="c1"># Get sort parameter</span>
            <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort_by&#39;</span><span class="p">)</span>
            
            <span class="c1"># Get missing persons</span>
            <span class="n">missing_person_service</span> <span class="o">=</span> <span class="n">MissingPersonService</span><span class="p">()</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">missing_person_service</span><span class="o">.</span><span class="n">get_all_missing_persons</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
                <span class="n">search_query</span><span class="o">=</span><span class="n">search_query</span><span class="p">,</span>
                <span class="n">sort_by</span><span class="o">=</span><span class="n">sort_by</span>
            <span class="p">)</span>
            
            <span class="c1"># Get statistics if requested</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_stats&#39;</span><span class="p">):</span>
                <span class="n">statistics</span> <span class="o">=</span> <span class="n">missing_person_service</span><span class="o">.</span><span class="n">get_missing_persons_statistics</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">statistics</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># Paginate results</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">response_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">statistics</span><span class="p">:</span>
                    <span class="n">response_data</span><span class="p">[</span><span class="s1">&#39;statistics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">statistics</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
            
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">response_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">statistics</span><span class="p">:</span>
                <span class="n">response_data</span><span class="p">[</span><span class="s1">&#39;statistics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">statistics</span>
            
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span></div>
</div>


<div class="viewcode-block" id="MissingPersonDocumentViewSet">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonDocumentViewSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MissingPersonDocumentViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">MissingPersonDocument</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MissingPersonDocumentSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">]</span>

<div class="viewcode-block" id="MissingPersonDocumentViewSet.perform_create">
<a class="viewcode-back" href="../../missing_persons.html#missing_persons.views.MissingPersonDocumentViewSet.perform_create">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">uploaded_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Reunite</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Sachin.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>